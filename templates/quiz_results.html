{% extends "base.html" %}
{% block title %}Quiz Results - {{ quiz_results.quiz_title }}{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">
                    <i class="bi bi-trophy"></i> Quiz Results
                </h2>
                <p class="text-muted mb-0">{{ quiz_results.quiz_title }}</p>
            </div>
            <div>
                <a href="{{ url_for('student_quizzes') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Quizzes
                </a>
            </div>
        </div>

        <!-- Overall Score Card -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="card-title mb-3">Your Score</h3>
                        <div class="row">
                            <div class="col-4">
                                <div class="display-4 fw-bold text-primary">{{ quiz_results.score }}</div>
                                <small class="text-muted">Score</small>
                            </div>
                            <div class="col-4">
                                <div class="display-4 fw-bold text-secondary">{{ quiz_results.total_marks }}</div>
                                <small class="text-muted">Total Marks</small>
                            </div>
                            <div class="col-4">
                                <div class="display-4 fw-bold 
                                    {% if quiz_results.percentage >= 80 %}text-success
                                    {% elif quiz_results.percentage >= 60 %}text-warning
                                    {% else %}text-danger{% endif %}">
                                    {{ quiz_results.percentage }}%
                                </div>
                                <small class="text-muted">Percentage</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar 
                                    {% if quiz_results.percentage >= 80 %}bg-success
                                    {% elif quiz_results.percentage >= 60 %}bg-warning
                                    {% else %}bg-danger{% endif %}"
                                    role="progressbar" 
                                    style="width: {{ quiz_results.percentage }}%" 
                                    aria-valuenow="{{ quiz_results.percentage }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                    {{ quiz_results.percentage }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Quiz Summary</h6>
                        <div class="mb-2">
                            <strong>Subject:</strong> {{ quiz.get_subject_display() }}
                        </div>
                        <div class="mb-2">
                            <strong>Questions:</strong> {{ quiz.questions|length }}
                        </div>
                        <div class="mb-2">
                            <strong>Time Limit:</strong> 
                            {% if quiz.time_limit %}{{ quiz.time_limit }} minutes{% else %}No limit{% endif %}
                        </div>
                        <div class="mb-2">
                            <strong>Completed:</strong> 
                            {{ completed_at_formatted }}
                        </div>
                        <div class="alert alert-info mt-3">
                            <small><i class="bi bi-info-circle"></i> Results will be available for 2 hours</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Question Review -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Question Review</h5>
            </div>
            <div class="card-body">
                {% for question_id, question in questions.items() %}
                {% set question_result = quiz_results.question_results.get(question_id) %}
                {% if question_result %}
                <div class="question-review-item mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="mb-0">Question {{ loop.index }}
                            {% if question_result.score == question_result.max_marks %}
                            <span class="badge bg-success ms-2">
                                <i class="bi bi-check-circle"></i> Correct
                            </span>
                            {% elif question_result.score > 0 %}
                            <span class="badge bg-warning ms-2">
                                <i class="bi bi-dash-circle"></i> Partial
                            </span>
                            {% else %}
                            <span class="badge bg-danger ms-2">
                                <i class="bi bi-x-circle"></i> Incorrect
                            </span>
                            {% endif %}
                        </h6>
                        <div class="text-end">
                            <div class="fw-bold">{{ question_result.score }}/{{ question_result.max_marks }} marks</div>
                            <small class="text-muted">{{ "%.1f"|format((question_result.score / question_result.max_marks * 100) if question_result.max_marks > 0 else 0) }}%</small>
                        </div>
                    </div>
                    
                    <p class="mb-3 fw-bold">{{ question.question_text }}</p>
                    
                    {% if question.question_type == 'mcq' and question.normalized_options %}
                    <div class="row">
                        {% for option in question.normalized_options %}
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled
                                       {% if question_result.student_answer and question_result.student_answer == option[0] %}checked{% endif %}>
                                <label class="form-check-label">
                                    <span class="badge bg-light text-dark me-2">{{ 'ABCD'[loop.index0] }})</span>
                                    {{ option }}
                                    {% if question.correct_answer and question.correct_answer|string == loop.index|string %}
                                    <span class="badge bg-success ms-2">Correct Answer</span>
                                    {% endif %}
                                    {% if question_result.student_answer and question_result.student_answer == option[0] and not question_result.is_correct %}
                                    <span class="badge bg-danger ms-2">Your Answer</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% elif question.question_type == 'true_false' %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled
                                       {% if question_result.student_answer == 'True' %}checked{% endif %}>
                                <label class="form-check-label">
                                    True
                                    {% if question.correct_answer == True %}
                                    <span class="badge bg-success ms-2">Correct Answer</span>
                                    {% endif %}
                                    {% if question_result.student_answer == 'True' and not question_result.is_correct %}
                                    <span class="badge bg-danger ms-2">Your Answer</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled
                                       {% if question_result.student_answer == 'False' %}checked{% endif %}>
                                <label class="form-check-label">
                                    False
                                    {% if question.correct_answer == False %}
                                    <span class="badge bg-success ms-2">Correct Answer</span>
                                    {% endif %}
                                    {% if question_result.student_answer == 'False' and not question_result.is_correct %}
                                    <span class="badge bg-danger ms-2">Your Answer</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <strong>Your Answer:</strong> 
                        <span class="{% if question_result.score == question_result.max_marks %}text-success{% elif question_result.score > 0 %}text-warning{% else %}text-danger{% endif %}">
                            {{ question_result.student_answer }}
                        </span>
                    </div>
                    
                    <div class="mt-2">
                        <strong>Correct Answer:</strong> 
                        <span class="text-success fw-bold">{{ question_result.correct_answer }}</span>
                    </div>
                    
                    {% if question.explanation %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <strong>Explanation:</strong> {{ question.explanation }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}