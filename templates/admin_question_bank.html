{% extends "base.html" %}
{% block title %}Admin - Question Bank Moderation{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">
                    <i class="bi bi-shield-check"></i> Question Bank Moderation
                </h2>
                <p class="text-muted mb-0">Review and approve questions from teachers</p>
            </div>
            <div>
                <form method="POST" action="{{ url_for('approve_all_questions') }}" class="d-inline" 
                      onsubmit="return confirm('Are you sure you want to approve all pending questions?')">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-all"></i> Approve All Pending
                    </button>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="status" class="form-label">Filter by Status</label>
                        <select name="status" id="status" class="form-select">
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending Approval</option>
                            <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                            <option value="" {% if not status_filter %}selected{% endif %}>All Questions</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="subject" class="form-label">Filter by Subject</label>
                        <select name="subject" id="subject" class="form-select">
                            <option value="">All Subjects</option>
                            {% for subject in subjects %}
                            <option value="{{ subject }}" {% if subject_filter == subject %}selected{% endif %}>{{ subject|title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary me-2">
                            <i class="bi bi-filter"></i> Filter
                        </button>
                        <a href="{{ url_for('admin_question_bank') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Questions List -->
        <div class="card">
            <div class="card-body">
                {% if questions.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Subject</th>
                                <th>Type</th>
                                <th>Difficulty</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for question in questions.items %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ question.question_text[:80] }}{% if question.question_text|length > 80 %}...{% endif %}</div>
                                    {% if question.explanation %}
                                    <small class="text-muted">{{ question.explanation[:40] }}{% if question.explanation|length > 40 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>{{ question.get_subject_display() }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ question.question_type|upper }}</span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if question.difficulty == 'easy' %}bg-success
                                        {% elif question.difficulty == 'medium' %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ question.difficulty|title }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if question.status == 'approved' %}bg-success
                                        {% elif question.status == 'rejected' %}bg-danger
                                        {% else %}bg-warning{% endif %}">
                                        {{ question.status|title }}
                                    </span>
                                    {% if question.rejection_reason %}
                                    <br><small class="text-danger">{{ question.rejection_reason }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ question.creator.username }}</td>
                                <td>{{ question.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if question.status == 'pending' %}
                                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" 
                                            data-bs-target="#moderateModal" 
                                            data-question-id="{{ question.id }}"
                                            data-action="approve">
                                        <i class="bi bi-check-circle"></i> Approve
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" 
                                            data-bs-target="#moderateModal" 
                                            data-question-id="{{ question.id }}"
                                            data-action="reject">
                                        <i class="bi bi-x-circle"></i> Reject
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if questions.has_prev or questions.has_next %}
                <nav aria-label="Question pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if questions.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin_question_bank', page=questions.prev_num, status=status_filter, subject=subject_filter) }}">
                                Previous
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        {% endif %}

                        {% for page_num in questions.iter_pages() %}
                        {% if page_num %}
                        <li class="page-item {% if page_num == questions.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('admin_question_bank', page=page_num, status=status_filter, subject=subject_filter) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if questions.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin_question_bank', page=questions.next_num, status=status_filter, subject=subject_filter) }}">
                                Next
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle display-1 text-muted"></i>
                    <h4 class="mt-3">No questions found</h4>
                    <p class="text-muted">All questions have been reviewed or no questions match the current filters.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Moderation Modal -->
<div class="modal fade" id="moderateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moderateModalLabel">Moderate Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="moderateForm" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" id="modalAction">
                    <div id="rejectReasonContainer" style="display: none;">
                        <label for="rejection_reason" class="form-label">Rejection Reason</label>
                        <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="3" 
                                placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" id="modalSubmitBtn">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const moderateModal = document.getElementById('moderateModal');
    const modalAction = document.getElementById('modalAction');
    const rejectReasonContainer = document.getElementById('rejectReasonContainer');
    const modalSubmitBtn = document.getElementById('modalSubmitBtn');
    const moderateForm = document.getElementById('moderateForm');

    moderateModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const questionId = button.getAttribute('data-question-id');
        const action = button.getAttribute('data-action');
        
        modalAction.value = action;
        moderateForm.action = `/admin/questions/${questionId}/approve`;
        
        if (action === 'approve') {
            modalSubmitBtn.className = 'btn btn-success';
            modalSubmitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Approve';
            rejectReasonContainer.style.display = 'none';
        } else {
            modalSubmitBtn.className = 'btn btn-danger';
            modalSubmitBtn.innerHTML = '<i class="bi bi-x-circle"></i> Reject';
            rejectReasonContainer.style.display = 'block';
        }
    });
});
</script>
{% endblock %}